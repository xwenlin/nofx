# 补丁日志 2025-01-13 (Patch Log 2025-01-13)

本文件记录2025年1月13日的所有自定义补丁和修复的详细信息。

---

## 2025-01-13 - 修复状态图标不更新和请求顺序问题

### 问题描述

#### 问题1：状态图标不更新
- **问题**: 添加、更新或删除模型/交易所配置后，状态图标（绿色/灰色圆点）不立即更新，需要刷新页面才能看到正确状态
- **场景**: 
  - 用户添加新模型配置后，状态图标应该立即显示为绿色（已启用）
  - 用户更新模型配置后，状态图标应该立即更新
  - 用户删除模型配置后，状态图标应该立即更新或消失
  - 但实际需要手动刷新页面才能看到正确状态
- **原因**: 
  - React 组件没有检测到状态变化，导致不重新渲染
  - 状态更新时没有创建新的对象引用
  - 列表项的 key 没有包含 `enabled` 状态，导致 React 无法识别变化
- **影响**: 
  - 用户体验差，无法实时看到配置状态
  - 需要手动刷新页面才能看到最新状态
  - 状态显示不准确，可能误导用户

#### 问题2：AlertDialog 可访问性警告
- **问题**: 删除模型或交易所时，控制台出现 `AlertDialogContent` 必须包含 `AlertDialogTitle` 的警告
- **原因**: 
  - Radix UI 的 `AlertDialog` 组件要求必须包含 `AlertDialogTitle` 以符合可访问性标准
  - 当没有提供标题时，组件没有渲染 `AlertDialogTitle`
- **影响**: 
  - 不符合 ARIA 可访问性要求
  - 控制台警告影响开发体验
  - 屏幕阅读器用户可能无法正确理解对话框内容

#### 问题3：请求顺序问题导致状态不正确
- **问题**: 保存配置后，立即 GET 请求返回的数据中 `enabled` 状态不正确（为 `false` 而不是 `true`）
- **场景**: 
  - 用户保存模型配置，设置 `enabled: true`
  - 保存成功后，立即调用 GET 请求获取最新数据
  - 返回的数据中 `enabled` 仍然是 `false`
  - 刷新页面后，`enabled` 才是 `true`
- **原因**: 
  - 使用 `toast.promise` 时，GET 请求可能在 PUT 请求完成之前执行
  - `toast.promise` 内部可能异步执行，导致请求顺序不确定
  - 后端虽然已经更新数据，但前端在更新完成前就获取了数据
- **影响**: 
  - 状态显示不正确
  - 用户体验差，需要刷新页面才能看到正确状态
  - 数据不一致

### 修复方案

#### 修复1：状态图标不更新问题

**方案**：
1. 添加 `updateKey` 状态用于强制重新渲染
2. 在所有状态更新操作后更新 `updateKey`
3. 在列表渲染时使用组合 key，包含 `updateKey` 和 `enabled` 状态
4. 确保状态更新时创建新的对象引用

**原理**：
- 使用组合 key 包含 `updateKey` 和 `enabled` 状态，当这些值变化时 React 会重新创建组件
- 每次更新后递增 `updateKey`，强制所有列表项重新渲染
- 创建新的对象引用确保 React 检测到变化

#### 修复2：AlertDialog 可访问性警告

**方案**：
- 确保 `AlertDialogTitle` 始终渲染
- 如果没有提供标题，使用默认标题 "确认" 并用 `sr-only` 类隐藏（仅对屏幕阅读器可见）

#### 修复3：请求顺序问题

**方案**：
- 将所有使用 `toast.promise` 的操作改为先执行 API 调用，再显示 toast
- 直接使用 `await` 确保 PUT 请求完成后再执行 GET 请求
- 移除不必要的 `setTimeout` 延迟

### 修改文件

#### `web/src/components/AITradersPage.tsx`

##### 1. 添加 `updateKey` 状态（第82行）

**修改前**:
```typescript
const [allModels, setAllModels] = useState<AIModel[]>([])
const [allExchanges, setAllExchanges] = useState<Exchange[]>([])
```

**修改后**:
```typescript
const [allModels, setAllModels] = useState<AIModel[]>([])
const [allExchanges, setAllExchanges] = useState<Exchange[]>([])
const [updateKey, setUpdateKey] = useState(0) // 用于强制重新渲染
```

##### 2. 修复 `handleSaveModelConfig` 函数（第473-572行）

**修改前**:
```typescript
await toast.promise(api.updateModelConfigs(request), {
  loading: '正在更新模型配置…',
  success: '模型配置已更新',
  error: '更新模型配置失败',
})

// 重新获取用户配置以确保数据同步
const refreshedModels = await api.getModelConfigs()
setAllModels(refreshedModels.map(m => ({ ...m })))
```

**修改后**:
```typescript
// 先执行更新操作，确保完成后再获取
await api.updateModelConfigs(request)
toast.success('模型配置已更新')

// 重新获取用户配置以确保数据同步
const refreshedModels = await api.getModelConfigs()

// 创建新的数组和对象引用，确保 React 检测到变化
setAllModels(refreshedModels.map(m => ({ ...m })))

// 强制触发重新渲染
setUpdateKey(prev => prev + 1)
```

##### 3. 修复 `handleSaveExchangeConfig` 函数（第626-722行）

**修改前**:
```typescript
await toast.promise(api.updateExchangeConfigsEncrypted(request), {
  loading: '正在更新交易所配置…',
  success: '交易所配置已更新',
  error: '更新交易所配置失败',
})

const refreshedExchanges = await api.getExchangeConfigs()
setAllExchanges(refreshedExchanges.map(e => ({ ...e })))
```

**修改后**:
```typescript
// 先执行更新操作，确保完成后再获取
await api.updateExchangeConfigsEncrypted(request)
toast.success('交易所配置已更新')

// 重新获取用户配置以确保数据同步
const refreshedExchanges = await api.getExchangeConfigs()
// 创建新的数组和对象引用，确保 React 检测到变化
setAllExchanges(refreshedExchanges.map(e => ({ ...e })))
// 强制触发重新渲染
setUpdateKey(prev => prev + 1)
```

##### 4. 修复 `handleDeleteConfig` 函数（第410-420行）

**修改前**:
```typescript
await toast.promise(config.updateApi(request), {
  loading: '正在更新配置…',
  success: '配置已更新',
  error: '更新配置失败',
})

const refreshedItems = await config.refreshApi()
config.setItems(refreshedItems)
```

**修改后**:
```typescript
// 先执行更新操作，确保完成后再获取
await config.updateApi(request)
toast.success('配置已更新')

// 重新获取用户配置以确保数据同步
const refreshedItems = await config.refreshApi()
config.setItems(refreshedItems)
```

##### 5. 修复模型列表渲染 key（第917行）

**修改前**:
```typescript
{configuredModels.map((model) => {
  return (
    <div key={model.id}>
```

**修改后**:
```typescript
{configuredModels.map((model) => {
  return (
    <div key={`${model.id}-${updateKey}-${model.enabled}`}>
```

##### 6. 修复交易所列表渲染 key（第996行）

**修改前**:
```typescript
{configuredExchanges.map((exchange) => {
  return (
    <div key={exchange.id}>
```

**修改后**:
```typescript
{configuredExchanges.map((exchange) => {
  return (
    <div key={`${exchange.id}-${updateKey}-${exchange.enabled}`}>
```

##### 7. 修复其他操作函数（第230-357行）

**修复的函数**：
- `handleCreateTrader` - 创建交易员
- `handleSaveEditTrader` - 更新交易员
- `handleDeleteTrader` - 删除交易员
- `handleToggleTrader` - 启动/停止交易员
- `handleSaveSignalSource` - 保存信号源配置

**修改模式**：
```typescript
// 修改前
await toast.promise(api.xxx(...), {
  loading: '...',
  success: '...',
  error: '...',
})

// 修改后
await api.xxx(...)
toast.success('...')
```

#### `web/src/components/ConfirmDialog.tsx`

##### 修复 AlertDialog 可访问性警告（第45-50行）

**修改前**:
```typescript
<AlertDialogContent>
  <div className="flex flex-col gap-5 text-center">
    {state.title && (
      <AlertDialogTitle className="text-xl">
        {state.title}
      </AlertDialogTitle>
    )}
    <AlertDialogDescription className="text-[var(--text-primary)] text-base font-medium">
      {state.message}
    </AlertDialogDescription>
  </div>
```

**修改后**:
```typescript
<AlertDialogContent>
  <div className="flex flex-col gap-5 text-center">
    <AlertDialogTitle className={state.title ? "text-xl" : "sr-only"}>
      {state.title || '确认'}
    </AlertDialogTitle>
    <AlertDialogDescription className="text-[var(--text-primary)] text-base font-medium">
      {state.message}
    </AlertDialogDescription>
  </div>
```

### 修复效果

#### 修复1效果
- ✅ 添加新模型配置后，状态图标立即显示为绿色
- ✅ 更新模型配置后，状态图标立即更新
- ✅ 删除模型配置后，状态图标立即更新或消失
- ✅ 交易所配置的状态图标同样能立即更新
- ✅ 不需要手动刷新页面即可看到最新状态

#### 修复2效果
- ✅ 删除操作不再出现可访问性警告
- ✅ 符合 ARIA 可访问性标准
- ✅ 屏幕阅读器用户可以正确理解对话框内容

#### 修复3效果
- ✅ 保存配置后，立即获取的数据中 `enabled` 状态正确
- ✅ 状态显示准确，不需要刷新页面
- ✅ 数据一致性得到保证
- ✅ 代码更简洁，移除了不必要的延迟

### 示例

**修复前**:
```
1. 用户添加模型配置
2. 保存成功，但状态图标仍然是灰色
3. 需要手动刷新页面才能看到绿色图标
4. 控制台出现可访问性警告
```

**修复后**:
```
1. 用户添加模型配置
2. 保存成功，状态图标立即显示为绿色
3. 不需要刷新页面
4. 无控制台警告
```

### 注意事项

- **React 重新渲染机制**：
  - 使用组合 key 强制重新渲染
  - 创建新的对象引用确保 React 检测到变化
  - 使用 `useMemo` 优化计算属性

- **异步请求顺序**：
  - 使用 `await` 确保请求顺序
  - 避免使用 `toast.promise` 导致的竞态条件
  - 保证数据一致性

- **数据库事务**：
  - SQLite WAL 模式 + `synchronous=FULL`
  - 确保数据持久化
  - 不需要额外的延迟等待（已移除 `setTimeout`）

### 测试建议

1. **状态图标更新测试**：
   - 添加新模型配置，验证状态图标是否立即显示为绿色
   - 更新模型配置，验证状态图标是否立即更新
   - 删除模型配置，验证状态图标是否立即更新或消失
   - 对交易所配置执行相同测试

2. **可访问性测试**：
   - 删除模型或交易所，验证控制台是否无警告
   - 使用屏幕阅读器测试对话框可访问性

3. **数据一致性测试**：
   - 保存配置后，立即检查状态是否正确
   - 验证不需要刷新页面即可看到最新状态
   - 验证多个操作连续执行时数据是否正确

4. **性能测试**：
   - 验证移除 `setTimeout` 后响应速度是否提升
   - 验证大量操作时是否有性能问题

---

