# 补丁日志 2025 (Patch Log 2025)

本文件记录2025年的所有自定义补丁和修复的详细信息。

---

## 2025-11-04 - 修复前端路径配置问题（合并dev分支后）

### 问题描述
- **BUG**: 合并新的dev分支后，前端访问的路径都没有前缀了
- **影响**: 前端无法正确访问静态资源、API接口和路由页面
- **根本原因**: dev分支覆盖了之前配置的 `/nofx/` base路径和 `/nofx-api` API前缀

### 修复方案
1. **API路径修复**：
   - 修复 `AuthContext.tsx` 中注册接口的路径
   - 确保所有API调用使用 `/nofx-api` 前缀

2. **路由适配base路径**：
   - 创建工具函数处理路由路径（`getBasePath`, `getFullPath`, `removeBasePath`）
   - 所有路由匹配和导航都适配base路径

3. **静态资源路径修复**：
   - 创建工具函数处理静态资源路径（`getIconPath`, `getImagePath`, `getLinkPath`）
   - 所有组件中的静态资源路径都使用工具函数

4. **页面跳转修复**：
   - 所有页面跳转都使用适配base路径的工具函数

### 修改文件

#### 1. `web/src/lib/api.ts`
- **状态**: ✅ 已正确配置
- **内容**: `API_BASE = '/nofx-api'` 已正确设置

#### 2. `web/src/lib/config.ts`
- **状态**: ✅ 已正确配置
- **内容**: 使用 `/nofx-api/config` 已正确设置

#### 3. `web/src/contexts/AuthContext.tsx`
- **修改内容**:
  - 第99行：注册接口从 `/api/register` 改为 `/nofx-api/register`
  - 第146、179行：登录/注册成功后的首页跳转使用 `import.meta.env.BASE_URL`

#### 4. `web/src/App.tsx`
- **修改内容**:
  - 第28-46行：添加工具函数 `getBasePath()`, `getFullPath()`, `removeBasePath()`
  - 第69-77行：`getInitialPage()` 函数使用 `removeBasePath()` 处理路径
  - 第83-98行：路由变化监听使用 `removeBasePath()` 处理路径
  - 第210-219行：路由状态同步使用 `removeBasePath()` 处理路径
  - 第234-241行：路由匹配使用 `removeBasePath()` 处理路径
  - 第256-274行：页面导航使用 `getFullPath()` 生成完整路径
  - 第310-325行：主应用导航使用 `getFullPath()` 生成完整路径
  - 第335-341行：交易员选择导航使用 `getFullPath()` 生成完整路径

#### 5. `web/src/pages/LandingPage.tsx`
- **修改内容**:
  - 第36-43行：页面跳转使用 `import.meta.env.BASE_URL` 适配base路径

#### 6. `web/src/components/LoginPage.tsx`
- **修改内容**:
  - 第64-67行：页面跳转使用 `import.meta.env.BASE_URL` 适配base路径

#### 7. `web/src/components/RegisterPage.tsx`
- **修改内容**:
  - 第102-105行：页面跳转使用 `import.meta.env.BASE_URL` 适配base路径

#### 8. `web/src/components/ModelIcons.tsx`
- **修改内容**:
  - 第17-25行：新增 `getLinkPath()` 函数，用于生成适配base路径的链接

#### 9. `web/src/components/landing/HeroSection.tsx`
- **修改内容**:
  - 第4行：导入 `getImagePath` 函数
  - 第111行：图片路径从 `/images/hand-bg.png` 改为 `getImagePath('hand-bg.png')`
  - 第121行：图片路径从 `/images/hand.png` 改为 `getImagePath('hand.png')`

#### 10. `web/src/components/landing/HeaderBar.tsx`
- **修改内容**:
  - 第5行：导入 `getLinkPath` 和 `getIconPath` 函数
  - 第49行：Logo链接从 `href='/'` 改为 `href={getLinkPath('/')}`
  - 第180行：竞赛页面链接从 `href='/competition'` 改为 `href={getLinkPath('/competition')}`
  - 第292行：登录页面链接从 `href='/login'` 改为 `href={getLinkPath('/login')}`
  - 第299行：注册页面链接从 `href='/register'` 改为 `href={getLinkPath('/register')}`
  - 第416行：移动端竞赛页面链接从 `href='/competition'` 改为 `href={getLinkPath('/competition')}`
  - 第590行：移动端登录页面链接从 `href='/login'` 改为 `href={getLinkPath('/login')}`
  - 第598行：移动端注册页面链接从 `href='/register'` 改为 `href={getLinkPath('/register')}`

#### 11. `web/index.html`
- **修改内容**:
  - 第16行：Favicon路径保持为 `/icons/nofx.svg`（Vite构建时会自动处理base路径）

### 技术细节

#### 工具函数说明

**`getBasePath()`**:
```typescript
const getBasePath = () => import.meta.env.BASE_URL || '/';
```
- 获取base路径（通常是 `/nofx/`）

**`getFullPath(path: string)`**:
```typescript
const getFullPath = (path: string) => {
  const base = getBasePath();
  if (base === '/') return path;
  if (path === '/' || path === '') return base.slice(0, -1);
  return base.slice(0, -1) + path;
};
```
- 将相对路径转换为完整的base路径
- 例如：`getFullPath('/competition')` → `/nofx/competition`

**`removeBasePath(fullPath: string)`**:
```typescript
const removeBasePath = (fullPath: string): string => {
  const base = getBasePath();
  if (base === '/' || !fullPath.startsWith(base)) return fullPath;
  const relative = fullPath.slice(base.length - 1);
  return relative || '/';
};
```
- 从完整路径中移除base路径，获取相对路径
- 例如：`removeBasePath('/nofx/competition')` → `/competition`

**`getLinkPath(path: string)`** (在 `ModelIcons.tsx` 中):
```typescript
export const getLinkPath = (path: string): string => {
  const baseUrl = import.meta.env.BASE_URL || '/';
  if (baseUrl === '/') return path;
  const baseWithoutSlash = baseUrl.slice(0, -1);
  return `${baseWithoutSlash}${path}`;
};
```
- 生成适配base路径的链接路径
- 例如：`getLinkPath('/competition')` → `/nofx/competition`

### 配置确认

#### `web/vite.config.ts`
```typescript
export default defineConfig({
  plugins: [react()],
  base: '/nofx/',  // ✅ 已正确配置
  server: {
    host: '0.0.0.0',
    port: 3000,
    proxy: {
      '/nofx-api': {  // ✅ 已正确配置
        target: 'http://localhost:18080',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/nofx-api/, '/api'),
      },
    },
  },
})
```

#### `nginx/nginx.conf`
```nginx
location /nofx-api/ {
    proxy_pass http://nofx:8080/api/;
    # ...
}
```
- ✅ nginx配置已正确

### 修复效果

- ✅ 所有API调用使用 `/nofx-api` 前缀
- ✅ 所有路由匹配和导航适配 `/nofx/` base路径
- ✅ 所有静态资源路径适配base路径
- ✅ 所有页面跳转适配base路径
- ✅ 前端可以正确部署在 `/nofx/` 子路径下

### 测试建议

- [ ] 验证所有API调用是否正确使用 `/nofx-api` 前缀
- [ ] 验证所有路由页面是否可以通过 `/nofx/` 前缀访问
- [ ] 验证静态资源（图片、图标）是否正常加载
- [ ] 验证页面跳转是否正常工作
- [ ] 验证favicon是否正常显示

---

